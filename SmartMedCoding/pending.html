<!DOCTYPE html>

<head>

    <meta charset="utf-8">
    <title>Smart Med Coding</title>

    <script type="text/javascript" src="js/jquery-1.11.3.js"></script>
    <script type="text/javascript" src="js/jquery.tipsy.js"></script>
    <script type="text/javascript" src="js/d3.v3.min.js"></script>
    <script type="text/javascript" src="js/jquery.multiple.select.js"></script>
    <script type="text/javascript" src="js/underscore-min.js"></script>
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/jspdf.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.js"></script>
    <script type="text/javascript" src="js/moment.min.js"></script>
    <script type="text/javascript" src="js/daterangepicker.js"></script>


    <link rel="stylesheet" type="text/css" media="screen" href="css/multiple-select.css">
    <link rel="stylesheet" type="text/css" media="screen" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="css/basic.css">
    <link rel="stylesheet" type="text/css" media="screen" href="css/feature.css">
    <link rel="stylesheet" type="text/css" media="screen" href="css/custom.css">
    <link rel="stylesheet" type="text/css" media="screen" href="css/multiple-select.css">
    <link rel="stylesheet" type="text/css" media="screen" href="css/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/tipsy.css">
    <link rel="stylesheet" type="text/css" media="screen" href="css//daterangepicker.css" />

    <!-- Include Date Range Picker -->

    <link rel="icon" type="image/png" href="images/favicon.ico">

</head>

<body>

    <br /><br /><br /><br />
    <div class="container">
        <div class="row">
            <div class="tab">
                <button class="tablinks active" onclick="openCity(event, 'inventory')">Pending Inventory Summary</button>
                <button class="tablinks" onclick="openCity(event, 'ageChort')">Pending Inventory By Age Cohort</button>
            </div>

            <div id="inventory" class="tabcontent">
                <div class="container-fluid detail_percent_display">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="chart">
                                    <div class="col-md-12 panel-body">
                                        <p class="form-inline header_form">

                                            <label value="input_date">Date Range:</label>
                                            <input type="text" name="daterange" class="dateRange" id="inventoryReportdatepicker" readonly />

                                            <label value="Specialty">Specialty: </label>
                                            <select multiple="multiple" id="inventoryReportSpeciality" class="Speciality inventoryReportmultiple"></select>

                                            <label value="Facility">Facility: </label>
                                            <select multiple="multiple" id="inventoryReportFacility" class="Facility inventoryReportmultiple"></select>

                                            <label value="Groupby">Group By: </label>
                                            <select id="inventoryReportGroupby" class="select_Groupby"></select>

                                            <label value="Chartby">Chart : </label>
                                            <select id="inventoryReportChartby" class="select_Chart">
                                                <option value="areaChart" class="name" selected="">Area Chart</option>
                                                <option value="lineChart" class="name" selected="">Line Chart</option>
                                                <option value="BarChart" class="name" selected="">Bar Chart</option>
                                            </select>

                                            <input type="button" value="Submit" class="inventoryReportGroupby_options btn btn-default"></input>
                                            &nbsp;&nbsp;&nbsp;
                                            <button type="button" id="inventoryReportPDF" align="right" value="submit" class="fa fa-file-pdf-o"></button>
                                            <a id="inventoryReportCSV"> <button id="inventoryReportBTN" class="fa fa-file-excel-o" aria-hidden="true"></button></a>
                                        </p>
                                        <hr class="linesep" />
                                        <div id="inventoryReportchart" style="height: 420px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ageChort" class="tabcontent">
                <div class="container-fluid detail_percent_display">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="chart">
                                    <div class="col-md-12 panel-body">
                                        <p class="form-inline header_form">
                                            <label value="input_date">Date Range:</label>
                                            <input type="text" name="daterange" class="dateRange" id="ageChortReportdatepicker" readonly />

                                            <label value="Specialty">Specialty: </label>
                                            <select multiple="multiple" id="ageChortReportSpeciality" class="Speciality ageChortReportmultiple"></select>

                                            <label value="Facility">Facility: </label>
                                            <select multiple="multiple" id="ageChortReportFacility" class="Facility ageChortReportmultiple"></select>

                                            <label value="Groupby">Group By: </label>
                                            <select id="ageChortReportGroupby" class="select_Groupby"></select>

                                            <label value="Chartby">Chart : </label>
                                            <select id="ageChortReportChartby" class="select_Chart">
                                                <option value="multiLine" class="name" selected="">Multi Line Series</option>
                                                <option value="horizontalGroupBar" class="name" selected="">Horizontal Group Bar</option>
                                                <option value="groupBar" class="name" selected="">Group Bar</option>
                                                <option value="stackedBar" class="name" selected="">stacked Bar</option>
                                            </select>

                                            <input type="button" value="Submit" class="ageChortReportGroupby_options btn btn-default"></input>
                                            &nbsp;&nbsp;&nbsp;

                                            <button type="button" id="ageChortReportPDF" align="right" value="submit" class="fa fa-file-pdf-o"></button>
                                            <a id="ageChortReportCSV"> <button id="ageChortReportBTN" class="fa fa-file-excel-o" aria-hidden="true"></button></a>

                                        </p>
                                        <hr class="linesep" />
                                        <div id="ageChortReportchart" style="height: 420px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>
<script>
    function addThousandsSeparator(input) {
        var output = input
        if (parseFloat(input)) {
            input = new String(input);
            var parts = input.split(".");
            parts[0] = parts[0].split("").reverse().join("").replace(/(\d{3})(?!$)/g, "$1,").split("").reverse().join("");
            output = parts.join(".");
        }
        return output;
    }

    function iJSONToCSVConvertor(JSONDataValue, Report_Name) {

        var JSONData = JSON.stringify(JSONDataValue)
        var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;

        var CSV = '';
        var row = "";

        if (arrData[0] != undefined) {

            if (arrData[0][0] == undefined) {

                for (var index in arrData[0]) {

                    row += index + ',';
                }
                row = row.slice(0, -1);

                CSV += row + '\r\n';



                for (var i = 0; i < arrData.length; i++) {
                    var row = "";

                    for (var index in arrData[i]) {
                        row += '"' + arrData[i][index] + '",';
                    }
                    row.slice(0, row.length - 1);
                    //add a line break after each row
                    CSV += row + '\r\n';
                }

                if (CSV == '') {
                    alert("Invalid data");
                    return;
                }

                var csv = CSV;
                blob = new Blob([csv], {
                    type: 'text/csv'
                });
                var csvUrl = window.URL.createObjectURL(blob);
                var filename = 'inventoryReport.csv';

                $("#inventoryReportCSV").attr({
                    'download': filename,
                    'href': csvUrl
                });
            }

        }
    }

    $("#ageChortReportPDF").click(function() {

        var html = d3.select('#ageChortReportchart').select("svg")
            .attr("version", 1.1)
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .node().parentNode.innerHTML;

        var imgsrc = 'data:image/svg+xml;base64,' + btoa(html);

        var image = new Image();
        image.src = imgsrc;
        image.width = 960;
        image.height = 500;
        image.onload = function() {
            var canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            canvas.style = "border:1px solid #c3c3c3;background-color:#fff";

            var context = canvas.getContext('2d');
            context.drawImage(image, 0, 40);
            var dataURL = canvas.toDataURL();
            var pdf = new jsPDF('l', 'mm', [297, 210]);
            pdf.addImage(dataURL, 'JPEG', 22, 37);

            pdf.text(95, 20, 'Pending Inventory By Age Cohort');
            pdf.save("Pending Inventory By Age Cohort.pdf");

        }
    });

    function aJSONToCSVConvertor(JSONDataValue, Report_Name) {

        var JSONData = JSON.stringify(JSONDataValue)
        var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;

        var CSV = '';
        var row = "";

        if (arrData[0] != undefined) {

            if (arrData[0][0] == undefined) {

                for (var index in arrData[0]) {

                    row += index + ',';
                }
                row = row.slice(0, -1);

                CSV += row + '\r\n';



                for (var i = 0; i < arrData.length; i++) {
                    var row = "";

                    for (var index in arrData[i]) {
                        row += '"' + arrData[i][index] + '",';
                    }
                    row.slice(0, row.length - 1);
                    //add a line break after each row
                    CSV += row + '\r\n';
                }

                if (CSV == '') {
                    alert("Invalid data");
                    return;
                }

                var csv = CSV;
                blob = new Blob([csv], {
                    type: 'text/csv'
                });
                var csvUrl = window.URL.createObjectURL(blob);
                var filename = 'ageChortReport.csv';

                $("#ageChortReportCSV").attr({
                    'download': filename,
                    'href': csvUrl
                });
            }

        }
    }

    $("#inventoryReportPDF").click(function() {

        var html = d3.select('#inventoryReportchart').select("svg")
            .attr("version", 1.1)
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .node().parentNode.innerHTML;

        var imgsrc = 'data:image/svg+xml;base64,' + btoa(html);

        var image = new Image();
        image.src = imgsrc;
        image.width = 960;
        image.height = 500;
        image.onload = function() {
            var canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            canvas.style = "border:1px solid #c3c3c3;background-color:#fff";

            var context = canvas.getContext('2d');
            context.drawImage(image, 0, 40);
            var dataURL = canvas.toDataURL();
            var pdf = new jsPDF('l', 'mm', [297, 210]);
            pdf.addImage(dataURL, 'JPEG', 22, 37);

            pdf.text(115, 20, 'Pending Inventory Summary');
            pdf.save("Pending Inventory Report.pdf");

        }
    });

    function stackedBar(config, data, variable, Report_Name) {

        var elementId = config.chartSetting.elementId;
        var variables = config.chartSetting.variable;

        var height = config.chartSetting.height
        var width = config.chartSetting.width

        var margin = config.chartSetting.margin,
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom,
            colorArray = config.chartSetting.colorArray;

        var chartSetting_cols = config.chartSetting.columns;

        var x = d3.scale.ordinal()
            .rangeRoundBands([0, width], .1);

        var y = d3.scale.linear()
            .rangeRound([height, 0]);

        var color = d3.scale.ordinal().range(colorArray);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(d3.format(".2s"));

        d3.select('#' + elementId).select('svg').remove();

        var svg = d3.select("#" + elementId).append("svg")
            .attr("viewBox", "0 0 " + (width + margin.left + margin.right) + ' ' + (height + margin.top + margin.bottom))
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        function fade(t, a) {
            layer.filter(function(r) {
                return r[0].type.replace(" ", "_").replace(" ", "_") != a
            }).style("opacity", t)
        }

        var layers = d3.layout.stack()(chartSetting_cols.map(function(c) {
            return data.map(function(d) {
                return {
                    x: d[variable],
                    y: d[c],
                    type: c
                };
            });
        }));

        x.domain(layers[0].map(function(d) {
            return d.x;
        }));
        y.domain([0, d3.max(layers[layers.length - 1], function(d) {
            return d.y0 + d.y;
        })]).nice();


        var layer = svg.selectAll(".layer")
            .data(layers)
            .enter().append("g")
            .attr("class", "layer")
            .style("fill", function(d, i) {
                return color(i);
            })
            .style("stroke", function(d, i) {
                return d3.rgb(color(i)).darker();
            });

        layer.selectAll("rect")
            .data(function(d) {
                return d;
            })
            .enter().append("rect")
            .attr("class", "layer_rect")
            //            .attr("x", function(d) {
            //                return x(d.x);
            //            })
            .attr("x", function(d) {
                return x.rangeBand() > 60 ? x(d.x) + ((x.rangeBand() - 59) / 2) : x(d.x);
            })
            .attr("y", function(d) {
                return y(d.y + d.y0);
            })
            .attr("height", function(d) {
                return y(d.y0) - y(d.y + d.y0);
            })
            //.attr("width", x.rangeBand() - 1);
            .attr("width", x.rangeBand() > 60 ? 59 : x.rangeBand() - 1);

        xaxis_legends = svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (height) + ")")
            .call(xAxis);

        xaxis_legends.selectAll("text")
            .attr("y", 14)
            .attr("x", 0)
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .attr("font-size", x.rangeBand() > 12 ? '12px' : x.rangeBand() + 'px')
            .text(function(d) {
                return d.length > Math.floor(x.rangeBand() / 5) ? d.substring(0, Math.floor(x.rangeBand() / 5)) + '..' : d
            })

        xaxis_legends.append("text")
            .attr("class", "value")
            .attr("transform", "translate(" + (width) + ",0)")
            .attr("x", 16)
            .attr("y", 5)
            .style("text-anchor", "start")
            .text($('#' + Report_Name + 'Groupby').val().replace("_", " "));

        svg.append("g")
            .attr("class", "axis axis--y")
            .call(yAxis).append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("No of Accounts");

        // Draw legend
        var legend = svg.selectAll(".legend")
            .data(chartSetting_cols)
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) {
                return "translate(30," + i * 22 + ")";
            });

        legend.append("rect")
            .attr("x", width - 3)
            .attr("width", 18)
            .attr("height", 18)
            .attr("stroke", function(d, i) {
                return d3.rgb(color(i)).darker()
            })
            .attr("fill", function(d, i) {
                return color(i)
            })
            .attr("rx", 2)
            .on("mouseover", function(t) {
                return fade(.1, t.replace(" ", "_").replace(" ", "_"))
            })
            .on("mouseout", function(t) {
                return fade(1, t.replace(" ", "_").replace(" ", "_"))
            });

        legend.append("text")
            .attr("x", width + 20)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(function(d) {
                return d.length > 13 ? d.substring(0, 11).replace("_", " ") + '..' : d.replace("_", " ")
            });


        $('.layer_rect').tipsy({
            gravity: 'w',
            html: true,
            title: function() {
                var d = this.__data__;
                return variable.replace("_", " ") + ' : ' + d.x + ' <br/>' + d.type.replace("_", " ") + ' : ' + addThousandsSeparator(d.y)

            }
        });

        $('.axis path,.axis line,.axis1 path,.axis1 line').css({
            'fill': 'none',
            'stroke': '#000',
            'shape-rendering': 'crispEdges'
        });
        $('text').css({
            'font': '10px sans-serif'
        });

    }

    function multiLine(config, data, variable, Report_Name) {

        var elementId = config.chartSetting.elementId;
        var variables = config.chartSetting.variable;

        var chartSetting_cols = config.chartSetting.columns;

        var height = config.chartSetting.height
        var width = config.chartSetting.width

        var margin = config.chartSetting.margin,
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom,
            colorArray = config.chartSetting.colorArray;

        d3.select('#' + elementId).select('svg').remove();

        var svg = d3.select("#" + elementId).append("svg")
            .attr("viewBox", "0 0 " + (width + margin.left + margin.right) + ' ' + (height + margin.top + margin.bottom))
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var xScale = d3.scale.ordinal()
            .rangeRoundBands([0, width], .1);

        var yScale = d3.scale.linear()
            .domain([0, 10])
            .range([height, 0]);

        var color = d3.scale.ordinal()
            .range(colorArray);

        var xAxis = d3.svg.axis().
        scale(xScale)
            .orient("bottom")
            .ticks(7);

        var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left")
            .ticks(5)
            .tickFormat(d3.format(".2s"));

        color.domain(chartSetting_cols);

        var data2 = data;
        var categories = color.domain().map(function(name) {
            return {
                name: name,
                values: data.map(function(d) {
                    if (d[name] == 0) {
                        d[name] = 0.1;
                    }
                    return {
                        variable: d[variable],
                        rating: +(d[name]),
                        visible: (true),
                        name: name,
                    };
                }),
                visible: (true)
            };
        });

        xScale.domain(data.map(function(d) {
            return d[variable];
        }));

        category_max = d3.max(categories, function(c) {
            return d3.max(c.values, function(v) {
                return v.rating;
            });
        })

        yScale.domain([0, category_max]);


        xaxis_legends = svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (height) + ")")
            .call(xAxis);

        xaxis_legends.selectAll("text")
            .attr("y", 14)
            .attr("x", 0)
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .attr("font-size", xScale.rangeBand() > 12 ? '12px' : xScale.rangeBand() + 'px')
            .text(function(d) {
                return d.length > Math.floor(xScale.rangeBand() / 5) ? d.substring(0, Math.floor(xScale.rangeBand() / 5)) + '..' : d
            })

        xaxis_legends.append("text")
            .attr("class", "value")
            .attr("transform", "translate(" + (width) + ",0)")
            .attr("dy", ".71em")
            .attr("y", -12)
            .style("text-anchor", "end")
            .text($('#' + Report_Name + 'Groupby').val().replace("_", " "));


        svg.append("g")
            .attr("class", "y axis noSelect")
            .call(yAxis).append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("No of Accounts");

        var line = d3.svg.line()
            .x(function(d) {
                return xScale(d.variable);
            })
            .y(function(d) {
                return yScale(d.rating);
            })
            .defined(function(d) {
                return d.rating;
            });

        var issue = svg.selectAll(".issue")
            .data(categories)
            .enter().append("g")
            .attr("class", "issue");

        issue.append("path")
            .attr("class", "line")
            .style("pointer-events", "none")
            .attr("stroke-width", 2)
            .attr("transform", "translate(" + ((xScale.rangeBand() / 2)) + ", 0)")
            .attr("id", function(d) {
                return "line-" + d.name.replace(" ", "").replace("/", "");
            })
            .attr("d", function(d) {
                if (d.values.rating == 0) {
                    d.values.rating = 0.1;
                };
                return d.visible ? line(d.values) : null;
            }).attr("clip-path", "url(#clip)").style("stroke", function(d) {
                return color(d.name);
            });

        // what to do when we mouse over a bubble
        var mouseOn = function() {
            var circle = d3.select(this);

            // transition to increase size/opacity of bubble
            circle.transition()
                .duration(800).style("opacity", 1)
                .attr("r", 12).ease("elastic");

            // append lines to bubbles that will be used to show the precise data points.
            // translate their location based on margins
            svg.append("g")
                .attr("class", "guide")
                .append("line")
                .attr('stroke-width', '1')
                .attr("x1", circle.attr("cx"))
                .attr("x2", circle.attr("cx"))
                .attr("y1", circle.attr("cy"))
                .attr("y2", height)
                .style("stroke", circle.style("fill"))
                .transition().delay(200).duration(400).styleTween("opacity",
                    function() {
                        return d3.interpolate(0, 1);
                    })

            svg.append("g")
                .attr("class", "guide")
                .append("line")
                .attr('stroke-width', '1')
                .attr("x1", circle.attr("cx"))
                .attr("x2", 0)
                .attr("y1", circle.attr("cy"))
                .attr("y2", circle.attr("cy"))
                .style("stroke", circle.style("fill"))
                .transition().delay(200).duration(400).styleTween("opacity",
                    function() {
                        return d3.interpolate(0, 1);
                    });

            // function to move mouseover item to front of SVG stage, in case
            // another bubble overlaps it
            d3.selection.prototype.moveToFront = function() {
                return this.each(function() {
                    this.parentNode.appendChild(this);
                });
            };
        };
        // what happens when we leave a bubble?
        var mouseOff = function() {
            var circle = d3.select(this);

            // go back to original size and opacity
            circle.transition()
                .duration(800).style("opacity", 1)
                .attr("r", 6).ease("elastic");

            // fade out guide lines, then remove them
            d3.selectAll(".guide").transition().duration(100).styleTween("opacity",
                    function() {
                        return d3.interpolate(1, 0);
                    })
                .remove()
        };

        function fade(t, a) {
            issue.filter(function(r) {
                return r.name.replace(" ", "_").replace(" ", "_") != a
            }).style("opacity", t)
        }

        issue.selectAll("circle")
            .data(function(d) {
                return d.values
            })
            .enter().append("circle")
            .attr("r", function(d) {
                return d.visible ? 6 : 0;
            })
            .attr("cx", function(d) {
                return xScale(d.variable) + (xScale.rangeBand() / 2);
            })
            .attr("cy", function(d) {
                return yScale(d.rating);
            })
            .style("fill", function(d) {
                return color(d.name);
            })
            .attr("stroke", function(d, i) {
                return d3.rgb(color(d.name)).darker()
            })
            .on("mouseover", mouseOn)
            .on("mouseout", mouseOff);

        $('circle').tipsy({
            gravity: 'w',
            html: true,
            title: function() {
                var d = this.__data__;
                return variable.replace("_", " ") + ' : ' + d.variable + ' <br/>' + d.name.replace("_", " ") + ' : ' + addThousandsSeparator(d.rating)
            }
        });

        // Draw legend
        var legend = svg.selectAll(".legend")
            .data(chartSetting_cols)
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) {
                return "translate(30," + i * 22 + ")";
            });

        legend.append("rect")
            .attr("x", width - 3)
            .attr("width", 18)
            .attr("height", 18)
            .attr("stroke", function(d, i) {
                return d3.rgb(color(d)).darker()
            })
            .attr("fill", function(d, i) {
                return color(d)
            })
            .attr("rx", 2)
            .on("mouseover", function(t) {
                return fade(.1, t.replace(" ", "_").replace(" ", "_"))
            })
            .on("mouseout", function(t) {
                return fade(1, t.replace(" ", "_").replace(" ", "_"))
            });

        legend.append("text")
            .attr("x", width + 20)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(function(d) {
                return d.length > 19 ? d.substring(0, 17).replace("_", " ") + '..' : d.replace("_", " ")
            });

        $('.axis path,.axis line,.axis1 path,.axis1 line').css({
            'fill': 'none',
            'stroke': '#000',
            'shape-rendering': 'crispEdges'
        });
        $('.line').css({
            'fill': 'none'
        });
        $('text').css({
            'font': '10px sans-serif'
        });

    }

    function horizontalGroupBar(config, data, variable, Report_Name) {

        var elementId = config.chartSetting.elementId;
        var variables = config.chartSetting.variable;

        var height = config.chartSetting.height
        var width = config.chartSetting.width


        var margin = config.chartSetting.margin,
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom,
            colorArray = config.chartSetting.colorArray;

        var chartSetting_cols = config.chartSetting.columns;

        d3.select('#' + elementId).select('svg').remove();

        var svg = d3.select("#" + elementId).append("svg")
            .attr("viewBox", "0 0 " + (width + margin.left + margin.right) + ' ' + (height + margin.top + margin.bottom))
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var layers = d3.layout.stack()(chartSetting_cols.map(function(period, index) {
            return data.map(function(d) {
                return {
                    x: d[variable],
                    y: parseFloat(d[period]),
                    value: parseFloat(d[period]),
                    name: period,
                    sub_group: index
                };

            });
        }));

        var yGroupMax = d3.max(layers, function(layer) {
            return d3.max(layer, function(d) {
                return d.y;
            });
        });

        var y = d3.scale.ordinal()
            .domain(layers[0].map(function(d) {
                return d.x;
            }))
            .rangeRoundBands([0, height], .1);

        var y1 = d3.scale.ordinal();
        y1.domain(chartSetting_cols).rangeRoundBands([0, y.rangeBand()]);

        var x = d3.scale.linear()
            .domain([0, yGroupMax])
            .range([0, width]);

        var color = d3.scale.ordinal()
            .range(colorArray);

        color.domain(chartSetting_cols);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .ticks(7)
            .tickFormat(d3.format(".2s"));

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var layer = svg.selectAll(".layer")
            .data(layers)
            .enter().append("g")
            .attr("class", "layer");

        var rect = layer.selectAll("rect")
            .data(function(d) {
                return d;
            })
            .enter().append("rect")
            .attr("class", "group_bar")
            .attr("y", function(d) {
                return y(d.x) + (d.sub_group * y.rangeBand() / chartSetting_cols.length);
            })
            .attr("height", (y.rangeBand() / (chartSetting_cols.length)) - 2)
            .attr("x", 0)
            .attr("width", function(d) {
                return x(d.y);
            })
            .style("fill", function(d) {
                return color(d.name);
            })
            .style("stroke", function(d) {
                return d3.rgb(color(d.name)).darker();
            })
            .attr("data-title", function(d) {
                return d.x + ',' + d.name + ' ' + d.value
            })

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis).append("text")
            .attr("transform", "translate(" + (width) + ",0)")
            .attr("y", -12)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("No of Accounts");

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis).selectAll("text")
            //.attr("y", 14)
            //.attr("x", 0)
            .attr("dy", ".35em")
            // .attr("transform", "rotate(90)")
            .style("text-anchor", "end")
            .style("font-size", y.rangeBand() > 9 ? '9px' : y.rangeBand() + 'px')
            .text(function(d) {
                return d.length > Math.floor(y.rangeBand() / 2.5) ? d.substring(0, Math.floor(y.rangeBand() / 2.5)) + '..' : d
            });

        function fade(opacity, name) {
            rect
                .filter(function(d) {
                    return d.name.replace(" ", "_").replace(" ", "_") != name;
                })
                .style("opacity", opacity);
        }

        var legend = svg.selectAll(".legend")
            .data(chartSetting_cols)
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) {
                return "translate(30," + i * 22 + ")";
            });

        legend.append("rect")
            .attr("x", width - 3)
            .attr("width", 18)
            .attr("height", 18)
            .attr("stroke", function(d, i) {
                return d3.rgb(color(d)).darker()
            })
            .attr("fill", function(d, i) {
                return color(d)
            })
            .attr("rx", 2)
            .on("mouseover", function(t) {
                return fade(.1, t.replace(" ", "_").replace(" ", "_"))
            })
            .on("mouseout", function(t) {
                return fade(1, t.replace(" ", "_").replace(" ", "_"))
            });

        legend.append("text")
            .attr("x", width + 20)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(function(d) {
                return d.length > 19 ? d.substring(0, 17).replace("_", " ") + '..' : d.replace("_", " ")
            });

        $('.group_bar').tipsy({
            gravity: 'w',
            html: true,
            title: function() {
                var d = this.__data__;
                return variable.replace("_", " ") + ' : ' + d.x + ' <br/>' + d.name.replace("_", " ") + ' : ' + addThousandsSeparator(d.value)
            }
        });

        $('.axis path,.axis line,.axis1 path,.axis1 line').css({
            'fill': 'none',
            'stroke': '#000',
            'shape-rendering': 'crispEdges'
        });
        $('text').css({
            'font': '10px sans-serif'
        });

    }

    function groupBar(config, data, variable, Report_Name) {

        var elementId = config.chartSetting.elementId;
        var variables = config.chartSetting.variable;

        var height = config.chartSetting.height
        var width = config.chartSetting.width

        var margin = config.chartSetting.margin,
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom,
            colorArray = config.chartSetting.colorArray;

        var chartSetting_cols = config.chartSetting.columns;

        var x0 = d3.scale.ordinal()
            .rangeRoundBands([0, width], .1);

        var x1 = d3.scale.ordinal();

        var y = d3.scale.linear()
            .rangeRound([height, 0]);

        var color = d3.scale.ordinal()
            .range(colorArray);

        var xAxis = d3.svg.axis()
            .scale(x0)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(d3.format(".2s"));

        d3.select('#' + elementId).select('svg').remove();

        var svg = d3.select("#" + elementId).append("svg")
            .attr("viewBox", "0 0 " + (width + margin.left + margin.right) + ' ' + (height + margin.top + margin.bottom))
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        color.domain(chartSetting_cols);

        data.forEach(function(d) {
            var y0 = 0;
            d.groups = color.domain().map(function(name) {
                return {
                    name: name,
                    value: +d[name],
                    groupby: d[variable]
                };
            });
        });

        x0.domain(data.map(function(d) {
            return d[variable];
        }));
        x1.domain(chartSetting_cols).rangeRoundBands([0, x0.rangeBand()]);
        y.domain([0, d3.max(data, function(d) {
            return d3.max(d.groups, function(d) {
                return d.value;
            });
        })]);

        xaxis_legends = svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (height) + ")")
            .call(xAxis);

        xaxis_legends.selectAll("text")
            .attr("y", 14)
            .attr("x", 0)
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .attr("font-size", x0.rangeBand() > 12 ? '12px' : x0.rangeBand() + 'px')
            .text(function(d) {
                return d.length > Math.floor(x0.rangeBand() / 5) ? d.substring(0, Math.floor(x0.rangeBand() / 5)) + '..' : d
            })

        xaxis_legends.append("text")
            .attr("class", "value")
            .attr("transform", "translate(" + (width) + ",0)")
            .attr("x", 8)
            .attr("y", 5)
            .style("text-anchor", "start")
            .text($('#' + Report_Name + 'Groupby').val().replace("_", " "));

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis).append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("No of Accounts");

        var state = svg.selectAll(".state")
            .data(data)
            .enter().append("g")
            .attr("class", "g")
            .attr("transform", function(d) {
                return "translate(" + x0(d[variable]) + ",0)";
            });

        function fade(t, a) {
            $('.group_bar').css("opacity", t);
            $('.' + a).css("opacity", 1);
        }

        state.selectAll("rect")
            .data(function(d) {
                return d.groups;
            })
            .enter().append("rect")
            .attr("class", "group_bar")
            .attr("class", function(d) {
                return "group_bar " + d.name.replace(" ", "_").replace(" ", "_")
            })
            //.attr("width", x1.rangeBand() - 1)
            .attr("width", x1.rangeBand())
            .attr("x", function(d) {
                return x0.rangeBand() > 75 ? ((x0.rangeBand() - 75) / 2) + x1(d.name) : x1(d.name)
            })
            //           .attr("x", function(d) { // return x1(d.name); // })
            .attr("y", function(d) {
                return y(d.value);
            })
            .attr("data-title", function(d) {
                return d.groupby + ',' + d.name + ' ' + d.value
            })
            .attr("height", function(d) {
                return height - y(d.value);
            })
            .attr("fill", function(d) {
                return color(d.name);
            })
            .attr("stroke", function(d) {
                return d3.rgb(color(d.name)).darker();
            });

        var legend = svg.selectAll(".legend")
            .data(chartSetting_cols)
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) {
                return "translate(30," + i * 22 + ")";
            });

        legend.append("rect")
            .attr("x", width - 3)
            .attr("width", 18)
            .attr("height", 18)
            .attr("stroke", function(d, i) {
                return d3.rgb(color(d)).darker()
            })
            .attr("fill", function(d, i) {
                return color(d)
            })
            .attr("rx", 2)
            .on("mouseover", function(t) {
                return fade(.1, t.replace(" ", "_").replace(" ", "_"))
            })
            .on("mouseout", function(t) {
                return fade(1, t.replace(" ", "_").replace(" ", "_"))
            });

        legend.append("text")
            .attr("x", width + 20)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(function(d) {
                return d.length > 19 ? d.substring(0, 17).replace("_", " ") + '..' : d.replace("_", " ")
            });

        $('.group_bar').tipsy({
            gravity: 'w',
            html: true,
            title: function() {
                var d = this.__data__;
                return variable.replace("_", " ") + ' : ' + d.groupby + ' <br/>' + d.name.replace("_", " ") + ' : ' + addThousandsSeparator(d.value)
            }
        });

        $('.axis path,.axis line,.axis1 path,.axis1 line').css({
            'fill': 'none',
            'stroke': '#000',
            'shape-rendering': 'crispEdges'
        });
        $('text').css({
            'font': '10px sans-serif'
        });

    }

    function groupBarPlusLine(config, data, variable, Report_Name) {

        var elementId = config.chartSetting.elementId;
        var variables = config.chartSetting.variable;

        var height = config.chartSetting.height
        var width = config.chartSetting.width

        var line_data = config.chartSetting.line;

        var margin = config.chartSetting.margin,
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom,
            colorArray = config.chartSetting.colorArray;

        var chartSetting_cols = config.chartSetting.columns;

        var x0 = d3.scale.ordinal()
            .rangeRoundBands([0, width], .1);

        var x1 = d3.scale.ordinal();

        var y = d3.scale.linear()
            .rangeRound([height, 0]);

        var y1 = d3.scale.linear()
            .range([height, 0]);

        var color = d3.scale.ordinal()
            .range(colorArray);

        var xAxis = d3.svg.axis()
            .scale(x0)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(d3.format(".2s"));

        var y1Axis = d3.svg.axis()
            .scale(y1)
            .orient("right")
            .ticks(5);

        d3.select('#' + elementId).select('svg').remove();

        var svg = d3.select("#" + elementId).append("svg")
            .attr("viewBox", "0 0 " + (width + margin.left + margin.right) + ' ' + (height + margin.top + margin.bottom))
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        color.domain(chartSetting_cols);

        data.forEach(function(d) {
            var y0 = 0;
            d.groups = color.domain().map(function(name) {
                return {
                    name: name,
                    value: +d[name],
                    groupby: d[variable]
                };
            });
        });

        x0.domain(data.map(function(d) {
            return d[variable];
        }));
        x1.domain(chartSetting_cols).rangeRoundBands([0, x0.rangeBand()]);
        y.domain([0, d3.max(data, function(d) {
            return d3.max(d.groups, function(d) {
                return d.value;
            });
        })]);
        y1.domain([0, d3.max(data, function(d) {
            return d[line_data];
        })]).nice();

        // Define the line
        var valueline = d3.svg.line()
            .x(function(d) {
                return x0(d[variable]);
            })
            .y(function(d) {
                return y1(d[line_data]);
            })
            .defined(function(d) {
                return d[line_data];
            });

        xaxis_legends = svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (height) + ")")
            .call(xAxis);

        xaxis_legends.selectAll("text")
            .attr("y", 14)
            .attr("x", 0)
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .attr("font-size", x0.rangeBand() > 12 ? '12px' : x0.rangeBand() + 'px')
            .text(function(d) {
                return d.length > Math.floor(x0.rangeBand() / 5) ? d.substring(0, Math.floor(x0.rangeBand() / 5)) + '..' : d
            })

        xaxis_legends.append("text")
            .attr("class", "value")
            .attr("transform", "translate(" + (width) + ",0)")
            .attr("x", 16)
            .attr("y", 5)
            .style("text-anchor", "start")
            .text($('#' + Report_Name + 'Groupby').val().replace("_", " "));

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis).append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("No of Accounts");


        // Add the Y Axis
        svg.append("g")
            .attr("class", "axis axis--y1")
            .attr("transform", "translate(" + width + ",0)")
            .call(y1Axis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", -15)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text(line_data);

        var state = svg.selectAll(".state")
            .data(data)
            .enter().append("g")
            .attr("class", "g")
            .attr("transform", function(d) {
                return "translate(" + x0(d[variable]) + ",0)";
            });

        function fade(t, a) {
            $('.group_bar').css("opacity", t);
            $('.' + a).css("opacity", 1);
        }

        state.selectAll("rect")
            .data(function(d) {
                return d.groups;
            })
            .enter().append("rect")
            .attr("class", "group_bar")
            .attr("class", function(d) {
                return "group_bar " + d.name.replace(" ", "_").replace(" ", "_")
            })
            .attr("width", x1.rangeBand() - 4)
            .attr("x", function(d) {
                return x1(d.name); + 2
            })
            .attr("y", function(d) {
                return y(d.value);
            })
            .attr("data-title", function(d) {
                return d.groupby + ',' + d.name + ' ' + d.value
            })
            .attr("height", function(d) {
                return height - y(d.value);
            })
            .attr("fill", function(d) {
                return color(d.name);
            })
            .attr("stroke", function(d) {
                return d3.rgb(color(d.name)).darker();
            });

        // Add the valueline path.
        svg.append("path")
            .attr("class", "line")
            .attr("transform", "translate(" + x0.rangeBand() / 2 + ",0)")
            .attr("d", valueline(data))
            .attr("stroke", "steelblue")
            .attr("stroke-width", 2)
            .attr("fill", 'none');

        // what to do when we mouse over a bubble
        var mouseOn = function() {
            var circle = d3.select(this);

            // transition to increase size/opacity of bubble
            circle.transition()
                .duration(800).style("opacity", 1)
                .attr("r", 12).ease("elastic");

            // append lines to bubbles that will be used to show the precise data points.
            // translate their location based on margins
            svg.append("g")
                .attr("class", "guide")
                .append("line")
                .attr('stroke-width', '1')
                .attr("x1", parseFloat(circle.attr("cx")) + (x0.rangeBand() / 2))
                .attr("x2", parseFloat(circle.attr("cx")) + (x0.rangeBand() / 2))
                .attr("y1", circle.attr("cy"))
                .attr("y2", height)
                .style("stroke", circle.style("fill"))
                .transition().delay(200).duration(400).styleTween("opacity",
                    function() {
                        return d3.interpolate(0, 1);
                    })

            svg.append("g")
                .attr("class", "guide")
                .append("line")
                .attr('stroke-width', '1')
                .attr("x1", parseFloat(circle.attr("cx")) + (x0.rangeBand() / 2))
                .attr("x2", width)
                .attr("y1", circle.attr("cy"))
                .attr("y2", circle.attr("cy"))
                .style("stroke", circle.style("fill"))
                .transition().delay(200).duration(400).styleTween("opacity",
                    function() {
                        return d3.interpolate(0, 1);
                    });

            // function to move mouseover item to front of SVG stage, in case
            // another bubble overlaps it
            d3.selection.prototype.moveToFront = function() {
                return this.each(function() {
                    this.parentNode.appendChild(this);
                });
            };
        };
        // what happens when we leave a bubble?
        var mouseOff = function() {
            var circle = d3.select(this);

            // go back to original size and opacity
            circle.transition()
                .duration(800).style("opacity", 1)
                .attr("r", 6).ease("elastic");

            // fade out guide lines, then remove them
            d3.selectAll(".guide").transition().duration(100).styleTween("opacity",
                    function() {
                        return d3.interpolate(1, 0);
                    })
                .remove()
        };

        var circles = svg.selectAll(".circle")
            .data(data)
            .enter()
            .append("g")
            .append("circle")
            .attr("class", 'circle')
            .attr("r", 6)
            .attr("transform", "translate(" + x0.rangeBand() / 2 + ",0)")
            .attr("cx", function(d) {
                return x0(d[variable]);
            })
            .attr("cy", function(d) {
                return y1(d[line_data]);
            })
            .attr("fill", d3.rgb('steelblue').brighter())
            .attr("stroke", 'steelblue')
            .on("mouseover", mouseOn)
            .on("mouseout", mouseOff);


        var linelegend = svg.selectAll(".linelegend")
            .data([line_data])
            .enter().append("g")
            .attr("class", "linelegend")
            .attr("transform", function(d, i) {
                return "translate(30," + i * 22 + ")";
            });

        linelegend.append("rect")
            .attr("x", width - 1)
            .attr("y", 2)
            .attr("width", 14)
            .attr("height", 14)
            .attr("rx", 7)
            .attr("stroke", function(d, i) {
                return 'steelblue'
            })
            .attr("fill", function(d, i) {
                return d3.rgb('steelblue').brighter()
            });

        linelegend.append("text")
            .attr("x", width + 20)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(function(d) {
                return d.length > 19 ? d.substring(0, 17).replace("_", " ") + '..' : d.replace("_", " ")
            });


        var legend = svg.selectAll(".legend")
            .data(chartSetting_cols)
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) {
                return "translate(30," + ((i + 1) * 22) + ")";
            });

        legend.append("rect")
            .attr("x", width - 3)
            .attr("width", 18)
            .attr("height", 18)
            .attr("stroke", function(d, i) {
                return d3.rgb(color(d)).darker()
            })
            .attr("fill", function(d, i) {
                return color(d)
            })
            .attr("rx", 2)
            .on("mouseover", function(t) {
                return fade(.1, t.replace(" ", "_").replace(" ", "_"))
            })
            .on("mouseout", function(t) {
                return fade(1, t.replace(" ", "_").replace(" ", "_"))
            });

        legend.append("text")
            .attr("x", width + 20)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(function(d) {
                return d.length > 19 ? d.substring(0, 17).replace("_", " ") + '..' : d.replace("_", " ")
            });

        $('.group_bar').tipsy({
            gravity: 'w',
            html: true,
            title: function() {
                var d = this.__data__;
                return variable.replace("_", " ") + ' : ' + d.groupby + ' <br/>' + d.name.replace("_", " ") + ' : ' + addThousandsSeparator(d.value)
            }
        });

        $('circle').tipsy({
            gravity: 'e',
            html: true,
            title: function() {
                var d = this.__data__;
                return variable.replace("_", " ") + " : " + d[variable] + '<br/> ' + line_data + ' : ' + d[line_data].toFixed(2);
            }
        });

        $('.axis path,.axis line,.axis1 path,.axis1 line').css({
            'fill': 'none',
            'stroke': '#000',
            'shape-rendering': 'crispEdges'
        });
        $('text').css({
            'font': '10px sans-serif'
        });

    }

    function areaChart(config, data, variable, Report_Name) {

        var elementId = config.chartSetting.elementId;
        var variables = config.chartSetting.variable;

        var height = config.chartSetting.height
        var width = config.chartSetting.width

        var margin = config.chartSetting.margin,
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom,
            colorArray = config.chartSetting.colorArray;

        var chartSetting_cols = config.chartSetting.columns;

        d3.select('#' + elementId).select('svg').remove();

        var svg = d3.select("#" + elementId).append("svg")
            .attr("viewBox", "0 0 " + (width + margin.left + margin.right) + ' ' + (height + margin.top + margin.bottom))
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var colors = d3.scale.category20();

        x = d3.scale.ordinal().rangeRoundBands([0, width], .1),
            y = d3.scale.linear().range([height, 0]),

            xAxis = d3.svg.axis().scale(x).orient("bottom"),
            yAxis = d3.svg.axis().scale(y).orient("left").ticks(4),

            color = d3.scale.ordinal().range(colorArray);

        color.domain(['Pending']);
        data.forEach(function(d) {
            d.Day = d.Day;
        });

        var area = d3.svg.area()
            .x(function(d) {
                return x(d[variable]);
            })
            .y1(function(d) {
                return y(d.Pending);
            });
        var color = d3.scale.ordinal().range(colorArray);

        var parameterdata = _.uniq(_.pluck(data, variable));

        x.domain(parameterdata).rangeRoundBands([0, width]);

        y.domain([0, d3.max(data, function(d) {
            return d.Pending;
        })]);

        area.y0(y(0));

        svg.append("path")
            .datum(data)
            .attr("fill", "lightblue")
            .attr("stroke", "steelblue")
            .attr("transform", "translate(" + x.rangeBand() / 2 + ",0)")
            .attr("d", area);

        var issue = svg.selectAll(".issue")
            .data(data)
            .enter().append("g")
            .attr("class", "issue");

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis).selectAll("text")
            .attr("y", 14)
            .attr("x", 0)
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .attr("font-size", x.rangeBand() > 12 ? '12px' : x.rangeBand() + 'px')
            .text(function(d) {
                return d.length > Math.floor(x.rangeBand() / 5) ? d.substring(0, Math.floor(x.rangeBand() / 5)) + '..' : d
            });


        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("fill", "#000")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end")
            .text("# of Accounts");

        issue.selectAll("circle")
            .data(data)
            .enter().append("svg:circle")
            .attr("stroke", function(d) {
                return d3.rgb(color(d.name)).darker();
            })
            .attr("fill", function(d) {
                return color(d.name);
            })
            .attr("transform", "translate(" + x.rangeBand() / 2 + ",0)")
            .attr("cx", function(d, i) {
                return x(d[variable]);
            })
            .attr("cy", function(d) {
                return y(d.Pending);
            })
            .attr("r", function(d) {
                return 5;
            });

        $('circle').tipsy({
            gravity: 'w',
            html: true,
            title: function() {
                var d = this.__data__;
                return variable.replace("_", " ") + ' : ' + (d[variable]) + "<br/> Pending : " + (d.Pending);

            }
        });

        $('.axis path,.axis line,.axis1 path,.axis1 line').css({
            'fill': 'none',
            'stroke': '#000',
            'shape-rendering': 'crispEdges'
        });
        $('text').css({
            'font': '10px sans-serif'
        });
    }

    function lineChart(config, data, variable, Report_Name) {

        var elementId = config.chartSetting.elementId;
        var variables = config.chartSetting.variable;

        var height = config.chartSetting.height
        var width = config.chartSetting.width

        var margin = config.chartSetting.margin,
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom,
            colorArray = config.chartSetting.colorArray;

        var chartSetting_cols = config.chartSetting.columns;

        d3.select('#' + elementId).select('svg').remove();

        var svg = d3.select("#" + elementId).append("svg")
            .attr("viewBox", "0 0 " + (width + margin.left + margin.right) + ' ' + (height + margin.top + margin.bottom))
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var colors = d3.scale.category20();

        x = d3.scale.ordinal().rangeRoundBands([0, width], .1),
            y = d3.scale.linear().range([height, 0]),

            xAxis = d3.svg.axis().scale(x).orient("bottom"),
            yAxis = d3.svg.axis().scale(y).orient("left").ticks(4),

            color = d3.scale.ordinal().range(colorArray);

        color.domain(d3.keys(data[0]).filter(function(key) {
            return key !== "Day";
        }));
        data.forEach(function(d) {
            d.Day = d.Day;
        });

        x.domain(data.map(function(d) {
            return d[variable];
        }));

        y.domain([0, d3.max(data, function(d) {
            return d.Pending;
        })]);

        svg.append("g")
            .attr("class", "x axis noSelect")
            .attr("transform", "translate(0," + height + ")")
            .attr("fill", "#000")
            .call(xAxis).selectAll("text")
            .attr("y", 14)
            .attr("x", 0)
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .attr("font-size", x.rangeBand() > 12 ? '12px' : x.rangeBand() + 'px')
            .text(function(d) {
                return d.length > Math.floor(x.rangeBand() / 5) ? d.substring(0, Math.floor(x.rangeBand() / 5)) + '..' : d
            });



        svg.append("g")
            .attr("class", "y axis noSelect")
            .call(yAxis).append("text")
            .attr("fill", "#000")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end")
            .text("# of Accounts");

        var line = d3.svg.line().x(function(d) {
            return x(d[variable]);
        }).y(function(d) {
            return y(d.Pending);
        });

        var issue = svg.selectAll(".issue").data(data).enter().append("g").attr("class", "issue");

        issue.append("path")
            .datum(data)
            .attr("class", "line")
            .attr("transform", "translate(" + x.rangeBand() / 2 + ",0)")
            .attr("d", line)
            .attr("stroke", "steelblue")
            .attr("stroke-width", "1.5px")
            .attr("fill", 'none');

        issue.selectAll("circle")
            .data(data)
            .enter().append("svg:circle")
            .attr("transform", "translate(" + x.rangeBand() / 2 + ",0)")
            .attr("stroke", function(d) {
                return d3.rgb(color(d.name)).darker();
            })
            .attr("fill", function(d) {
                return color(d.name);
            })
            .attr("cx", function(d, i) {
                return x(d[variable]);
            })
            .attr("cy", function(d) {
                return y(d.Pending);
            })
            .attr("r", function(d) {
                return 5;
            });

        $('circle').tipsy({
            gravity: 'w',
            html: true,
            title: function() {
                var d = this.__data__;

                return variable.replace("_", " ") + ' : ' + (d[variable]) + "<br/> Pending : " + (d.Pending);

            }
        });

        $('.axis path,.axis line,.axis1 path,.axis1 line').css({
            'fill': 'none',
            'stroke': '#000',
            'shape-rendering': 'crispEdges'
        });
        $('text').css({
            'font': '10px sans-serif'
        });

    }

    function barChart(config, data, variable, Report_Name) {

        var elementId = config.chartSetting.elementId;
        var variables = config.chartSetting.variable;

        var height = config.chartSetting.height
        var width = config.chartSetting.width

        var line_data = config.chartSetting.line;

        var color = d3.scale.ordinal()
            .range(colorArray);

        var margin = config.chartSetting.margin,
            width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom,
            colorArray = config.chartSetting.colorArray;

        var chartSetting_cols = config.chartSetting.columns;

        var x = d3.scale.ordinal().rangeRoundBands([0, width], .05);

        var y = d3.scale.linear().range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .ticks(5);


        data.forEach(function(d) {

            d.groups = color.domain().map(function(name) {
                return {
                    name: name,
                    value: +d[name],
                    groupby: d[variable]
                };
            });

            d.Pending = +d.Pending;
        });


        x.domain(data.map(function(d) {
            return d[variable];
        }));
        y.domain([0, d3.max(data, function(d) {
            return d.Pending;
        })]);

        d3.select('#' + elementId).select('svg').remove();

        var svg = d3.select("#" + elementId).append("svg")
            .attr("viewBox", "0 0 " + (width + margin.left + margin.right) + ' ' + (height + margin.top + margin.bottom))
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        color.domain(chartSetting_cols)

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .selectAll("text")
            .attr("y", 14)
            .attr("x", 0)
            .attr("dy", ".35em")
            // .attr("transform", "rotate(-40)")
            .style("text-anchor", "middle")
            .attr("font-size", x.rangeBand() > 12 ? '12px' : x.rangeBand() + 'px')
            .text(function(d) {
                return d.length > Math.floor(x.rangeBand() / 5) ? d.substring(0, Math.floor(x.rangeBand() / 5)) + '..' : d
            });

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("# of Accounts");

        svg.selectAll("bar")
            .data(data)
            .enter().append("rect")
            .style("fill", "steelblue")
            //            .attr("x", function(d) {
            //                return x(d[variable]);
            //            })
            //            .attr("width", x.rangeBand())
            .attr("x", function(d) {
                return x.rangeBand() > 60 ? x(d[variable]) + ((x.rangeBand() - 59) / 2) : x(d[variable]);
            })
            .attr("width", x.rangeBand() > 60 ? 59 : x.rangeBand() - 1)
            .attr("y", function(d) {
                return y(d.Pending);
            })
            .attr("height", function(d) {
                return height - y(d.Pending);
            });


        //Adding Label to top of the each bar
        svg.selectAll("barText")
            .data(data)
            .enter().append("text")
            .attr("x", function(d) {
                return x(d[variable]) + x.rangeBand() / 2;
            })
            .attr("text-anchor", 'middle')
            .attr("font-size", x.rangeBand() > 12 ? '12px' : x0.rangeBand() + 'px')
            .attr("y", function(d) {
                return y(d.Pending) - 4;
            })
            .text(function(d) {
                return d.Pending
            });



        //Tool Tip for ripsy
        $('rect').tipsy({
            gravity: 'w',
            html: true,
            title: function() {
                var d = this.__data__;
                return variable.replace("_", " ") + ' : ' + (d[variable]) + "<br/> Pending : " + (d.Pending);
            }
        });

        $('.axis path,.axis line,.axis1 path,.axis1 line').css({
            'fill': 'none',
            'stroke': '#000',
            'shape-rendering': 'crispEdges'
        });
        $('text').css({
            'font': '10px sans-serif'
        });

    }

    function tabExpansion(Report_Name) {

        var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        var quarterNames = ["Q1", "Q2", "Q3", "Q4"];


        if ($('#' + Report_Name + 'Groupby').has("option")[0] == undefined) {

            if (Report_Name == 'inventoryReport') {

                var select_box = d3.select('#' + Report_Name + 'Groupby')
                    .selectAll("option")
                    .data(['Day', 'Week', 'Month', 'Quarter', 'Year'])
                    .enter().append("option")
                    .attr("value", function(d) {
                        return d;
                    })
                    .attr("class", "name")
                    .text(function(d) {
                        return d.replace("_", " ")
                    });
            } else {

                var select_box = d3.select('#' + Report_Name + 'Groupby')
                    .selectAll("option")
                    .data(['Facility', 'Speciality', 'CoderName', 'Status'])
                    .enter().append("option")
                    .attr("value", function(d) {
                        return d;
                    })
                    .attr("class", "name")
                    .text(function(d) {
                        return d
                    });
            }

            var select_box = d3.select('#' + Report_Name + 'Speciality')
                .selectAll("option")
                .data(['Faculty', 'General Surgery', 'GYN', 'Urology', 'Ortho', 'Pain Management'])
                .enter().append("option")
                .attr("value", function(d) {
                    return d;
                })
                .attr("class", "name")
                .attr("selected", "")
                .text(function(d) {
                    return d
                });

            var select_box = d3.select('#' + Report_Name + 'Facility')
                .selectAll("option")
                .data(['Aria Facilities'])
                .enter().append("option")
                .attr("value", function(d, i) {
                    return d;
                })
                .attr("class", "name")
                .attr("selected", "")
                .text(function(d) {
                    return d
                });

            var lm = new Date();
            lm.setMonth(-1);

            $('#' + Report_Name + 'datepicker').daterangepicker({
                startDate: lm,
                endDate: new Date(),
                ranges: {
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment()],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
                    'This Year': [moment().startOf('year'), moment()],
                    'Last Year': [moment().subtract(1, 'year').startOf('year'), , moment().subtract(1, 'year').endOf('year')],

                }
            });


            $('.' + Report_Name + 'multiple').multipleSelect({
                placeholder: "Here is the placeholder"
            });
        }

        $('.' + Report_Name + 'Groupby_options').on('click', function() {

            d3.csv('OverallInventorySummaryData.csv', function(data) {

                parseDate = d3.time.format("%m/%d/%Y").parse;
                parseTatDate = d3.time.format("%Y-%m-%d").parse;

                Date.prototype.getWeek = function() {
                    var onejan = new Date(this.getFullYear(), 0, 1);
                    return Math.ceil((((this - onejan) / 86400000) + onejan.getDay() + 1) / 7);
                }

                Date.prototype.getQuarter = function() {
                    return Math.floor((this.getMonth()) / 3);
                }

                function getDateOfWeek(weekNumber, year) {
                    //Create a date object starting january first of chosen year, plus the number of days in a week multiplied by the week number to get the right date.
                    return new Date(year, 0, 1 + ((weekNumber - 1) * 7));
                }
                var today = new Date();

                data.forEach(function(d) {

                    d['SortedDate'] = parseDate(d['CodedDate'])

                    d['CodedDate'] = (parseDate(d['CodedDate']).getMonth() + 1) + '/' + (parseDate(d['CodedDate']).getDate()) + '/' + (parseDate(d['CodedDate']).getYear() + 1900)

                    d['WeekDate'] = getDateOfWeek(d['SortedDate'].getWeek(), 2017)
                    d['WeekDate'] = (d['WeekDate'].getMonth() + 1) + '/' + (d['WeekDate'].getDate()) + '/' + (d['WeekDate'].getYear() + 1900)
                    d['MonthDate'] = monthNames[d['SortedDate'].getMonth()].substring(0, 3) + '-' + (d['SortedDate'].getYear() + 1900);
                    d['YearDate'] = d['SortedDate'].getYear() + 1900;
                    d['QuarterDate'] = quarterNames[d['SortedDate'].getQuarter()].substring(0, 3) + ' - ' + (d['SortedDate'].getYear() + 1900);
                    d['DayDate'] = d['CodedDate']

                    d['Completed (%)'] = (d['FinalStatus'] != 'Completed' ? 0 : 1);
                    d['Total_Inventory'] = 1
                    d['Completed'] = (d['FinalStatus'] != 'Completed' ? 0 : 1)
                    d['Pending'] = (d['FinalStatus'] != 'Completed' ? 1 : 0)

                    d['CodingEndDateTime'] = parseTatDate(d['CodingEndDateTime'].split(" ")[0])
                    d['porteddate'] = parseTatDate(d['porteddate'])

                    d['Diff_Date'] = parseInt((today - d['SortedDate']) / (1000 * 3600 * 24))
                    d['Diff_Date_Range'] = (d['Diff_Date'] < 10 ? '< 10 days' : (d['Diff_Date'] < 16 ? '11 to 15 days' : (d['Diff_Date'] < 31 ? '16 to 30 days ' : '> 30 days')))

                    d['TATDate'] = (d['CodingEndDateTime'] - d['porteddate']) / (1000 * 3600 * 24)
                    d['TAT Met Inventory'] = (d['TATDate'] < 2 ? 1 : 0)
                    d['TAT NotMet Inventory'] = (d['TATDate'] < 2 ? 0 : 1)
                    d['TAT MeT (%)'] = (d['TATDate'] < 2 ? 1 : 0)

                });

                var odata = data;
                var adata = data

                var inventoryReportgroupval = $('#inventoryReportGroupby').val();
                var ageChortReportGroupval = $('#ageChortReportGroupby').val();

                var inventoryReportSpeciality = [];
                $('#inventoryReportSpeciality :selected').each(function(i, selected) {
                    inventoryReportSpeciality[i] = $(selected).val();
                });

                var inventoryReportFacility = [];
                $('#inventoryReportFacility :selected').each(function(i, selected) {
                    inventoryReportFacility[i] = $(selected).val();
                });


                var ageChortReportSpeciality = [];
                $('#ageChortReportSpeciality :selected').each(function(i, selected) {
                    ageChortReportSpeciality[i] = $(selected).val();
                });

                var ageChortReportFacility = [];
                $('#ageChortReportFacility :selected').each(function(i, selected) {
                    ageChortReportFacility[i] = $(selected).val();
                });

                adata = adata.filter(function(x, y) {
                    return x.FinalStatus != 'Completed'
                })

                var inventoryReportdatepicker = $('#inventoryReportdatepicker').val().split(' - ');
                var ageChortReportdatepicker = $('#ageChortReportdatepicker').val().split(' - ');

                odata = odata.filter(function(x, y) {
                    return x.SortedDate >= new Date(inventoryReportdatepicker[0])
                })
                odata = odata.filter(function(x, y) {
                    return x.SortedDate <= new Date(inventoryReportdatepicker[1])
                })

                var odata_Facility = []
                _.each(odata, function(d) {
                    if (_.contains(inventoryReportFacility, d.Facility)) {
                        odata_Facility.push(d);
                    }
                });

                var odata_Speciality = []
                _.each(odata_Facility, function(d) {
                    if (_.contains(inventoryReportSpeciality, d.Speciality)) {
                        odata_Speciality.push(d);
                    }
                });

                adata = adata.filter(function(x, y) {
                    return x.SortedDate >= new Date(ageChortReportdatepicker[0])
                })
                adata = adata.filter(function(x, y) {
                    return x.SortedDate <= new Date(ageChortReportdatepicker[1])
                })

                var adata_Facility = []
                _.each(adata, function(d) {
                    if (_.contains(ageChortReportFacility, d.Facility)) {
                        adata_Facility.push(d);
                    }
                });

                var adata_Speciality = []
                _.each(adata_Facility, function(d) {
                    if (_.contains(ageChortReportSpeciality, d.Speciality)) {
                        adata_Speciality.push(d);
                    }
                });

                var adata_sets = d3.nest()
                    .key(function(d) {
                        return d[ageChortReportGroupval]
                    })
                    .key(function(d) {
                        return d['Diff_Date_Range']
                    })
                    .rollup(function(d) {
                        return {
                            'Total_Inventory': d3.sum(d, function(g) {
                                return g.Total_Inventory;
                            })
                        };
                    }).entries(adata_Speciality);

                var parameterby = _.uniq(_.pluck(adata_Speciality, 'Diff_Date_Range'));

                agegroup_data = []
                adata_sets.forEach(function(g) {
                    g.values[$('#ageChortReportGroupby').val()] = g.key

                    g.values.forEach(function(c) {
                        g.values[c.key] = c.values.Total_Inventory
                    });

                    agegroup_data.push(g.values)
                });


                var data_sets = d3.nest()
                    .key(function(d) {
                        return d[inventoryReportgroupval + 'Date']
                    })
                    .rollup(function(d) {
                        return {
                            'Pending': d3.sum(d, function(g) {
                                return g.Pending;
                            })
                        };
                    }).entries(odata_Speciality);


                group_data = []
                data_sets.forEach(function(g) {
                    g.values[$('#inventoryReportGroupby').val()] = g.key
                    group_data.push(g.values)

                });


                var config = {
                    chartSetting: {
                        elementId: "inventoryReportchart",
                        adaptive: "true",
                        width: 960,
                        height: 360,
                        margin: {
                            top: 15,
                            right: 15,
                            bottom: 25,
                            left: 40
                        },
                        colorArray: ['#00A3D9'],
                        columns: ['Pending'],
                        variable: $('#inventoryReportGroupby').val(),

                    }
                }

                var ageconfig = {
                    chartSetting: {
                        elementId: "ageChortReportchart",
                        adaptive: "true",
                        width: 960,
                        height: 360,
                        margin: {
                            top: 15,
                            right: 150,
                            bottom: 25,
                            left: 70
                        },
                        // colorArray: ['#ED7D31', '#5B9BD5', '#FFC000'],
                        colorArray: ['#00A3D9', '#00D936', '#FF8000'],
                        columns: parameterby,
                        variable: $('#ageChortReportGroupby').val()
                    }
                }


                if (group_data.length == 0) {
                    d3.select('#inventoryReportchart').select('svg').remove();
                } else if ($('#inventoryReportChartby').val() == 'lineChart') {
                    lineChart(config, group_data, $('#inventoryReportGroupby').val(), Report_Name);
                } else if ($('#inventoryReportChartby').val() == 'areaChart') {
                    areaChart(config, group_data, $('#inventoryReportGroupby').val(), Report_Name);
                } else {
                    barChart(config, group_data, $('#inventoryReportGroupby').val(), Report_Name);
                }


                if (agegroup_data.length == 0) {
                    d3.select('#ageChortReportchart').select('svg').remove();
                } else {
                    if ($('#ageChortReportChartby').val() == 'multiLine') {
                        multiLine(ageconfig, agegroup_data, $('#ageChortReportGroupby').val(), Report_Name);
                    } else if ($('#ageChortReportChartby').val() == 'groupBar') {
                        groupBar(ageconfig, agegroup_data, $('#ageChortReportGroupby').val(), Report_Name);
                    } else if ($('#ageChortReportChartby').val() == 'horizontalGroupBar') {
                        horizontalGroupBar(ageconfig, agegroup_data, $('#ageChortReportGroupby').val(), Report_Name);
                    } else {
                        stackedBar(ageconfig, agegroup_data, $('#ageChortReportGroupby').val(), Report_Name);
                    }
                }

                iJSONToCSVConvertor(group_data, Report_Name);
                aJSONToCSVConvertor(agegroup_data, Report_Name);

                group_data.forEach(function(o) {
                    o.groups = $('#inventoryReportGroupby').val()
                });


            });
        });
    }

    document.getElementById('inventory').style.display = "block";

    tabExpansion('inventoryReport');
    tabExpansion('ageChortReport');

    $('.inventoryReportGroupby_options').click();

    function openCity(evt, cityName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(cityName).style.display = "block";
        evt.currentTarget.className += " active";
        tabExpansion(cityName);

    }

</script>

</html>
